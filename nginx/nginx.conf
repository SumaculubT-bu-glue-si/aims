events {
    worker_connections 1024;
}

http {
    # -----------------------------------
    # UPSTREAM DEFINITIONS
    # -----------------------------------
    upstream nextjs {
        # Ensure this is set to 3000 to match the Next.js container port
        server frontend:3000; 
    }

    upstream laravel {
        # Check this one too, based on your backend logs: 
        # If the backend is running 'php artisan serve' on 9000, keep 9000.
        # If using PHP-FPM, keep 9000. 
        server backend:9000;
    }

    # -----------------------------------
    # MAIN SERVER BLOCK
    # -----------------------------------
    server {
        listen 80;
        
        # 1. Laravel API requests: Pass everything starting with /api/
        location /api/ {
            # Since Laravel is running with 'php artisan serve', we use proxy_pass
            # Remove the /api/ prefix when forwarding to Laravel
            rewrite ^/api/(.*)$ /$1 break;
            proxy_pass http://laravel;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
        }

        # 2. Next.js frontend: Handle all other requests
        location / {
            proxy_pass http://nextjs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}